<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Beamer Player</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: black;
        color: white;
        font-family: system-ui, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #root {
        text-align: center;
        max-width: 90vw;
      }
      img, video {
        margin-top: 20px;
        max-width: 90vw;
        max-height: 80vh;
        object-fit: contain;
      }
    </style>
  </head>
  <body>
    <div id="root">Starting player...</div>

    <script>
      const { initPlayer } = require("../player-core/dist/index.js");

      function resolveSrc(creative) {
        if (creative.local_file_path) {
          return creative.local_file_path;
        }

        const url = creative.file_url || "";

        if (url.startsWith("http://") || url.startsWith("https://") || url.startsWith("file://")) {
          return url;
        }

        const base = process.env.BEAMER_CMS_BASE_URL || "http://localhost:3000";
        return `${base}${url}`;
      }

      function renderCreative(creative) {
        const root = document.getElementById("root");
        const src = resolveSrc(creative);

        console.log("PLAYER DEBUG creative", {
          id: creative.creative_id,
          type: creative.type,
          fileUrl: creative.file_url,
          localPath: creative.local_file_path,
          resolvedSrc: src,
        });

        if (creative.type === "video") {
          root.innerHTML = `
            <div>Now Playing (VIDEO):</div>
            <div><strong>${creative.creative_id}</strong></div>
            <div>${creative.duration_seconds}s</div>
            <video id="creative-video"
                   src="${src}"
                   autoplay
                   muted
                   playsinline
                   loop></video>
          `;
          const video = document.getElementById("creative-video");
          if (video) {
            video.play().catch((err) => {
              console.error("Video play error:", err);
            });
          }
        } else {
          root.innerHTML = `
            <div>Now Playing (IMAGE):</div>
            <div><strong>${creative.creative_id}</strong></div>
            <div>${creative.duration_seconds}s</div>
            <img src="${src}" alt="Creative" onerror="console.error('Image load error:', this.src)" />
          `;
        }
      }

      function showError(err) {
        const root = document.getElementById("root");
        const message =
          (err && err.message) ||
          (typeof err === "string" ? err : "Unknown player error");

        console.error("Beamer player failed to start:", err);

        const isAlreadyLinked = 
          (err && err.name === "PlayerAlreadyRegisteredError") ||
          (err && err.code === "PLAYER_ALREADY_REGISTERED") ||
          (message && message.toLowerCase().includes("already linked"));

        if (isAlreadyLinked) {
          const playerId = err.existingPlayerId || "unknown";
          console.error(
            `\n========================================\n` +
            `Registration failed: screen already linked to player ${playerId}.\n` +
            `Action required: Go to CMS → Screen → "Disconnect Player"\n` +
            `========================================\n`
          );

          root.innerHTML = `
            <div style="padding: 32px; font-family: system-ui; max-width: 500px; text-align: center;">
              <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
              <div style="font-size: 24px; font-weight: bold; color: #ff8080; margin-bottom: 12px;">
                Screen Already Linked
              </div>
              <div style="font-size: 16px; color: #cccccc; margin-bottom: 20px;">
                This screen is already linked to another player.
              </div>
              <div style="font-size: 14px; color: #888888; background: #222; padding: 16px; border-radius: 8px;">
                <div style="margin-bottom: 8px;">To fix this:</div>
                <div style="text-align: left; padding-left: 20px;">
                  1. Open the Beamer CMS<br/>
                  2. Go to the Screen detail page<br/>
                  3. Click <strong style="color: #ff6666;">"Disconnect Player"</strong><br/>
                  4. Restart this player device
                </div>
              </div>
            </div>
          `;
          return;
        }

        root.innerHTML = `
          <div style="padding: 24px; font-family: system-ui; color: #ff8080;">
            <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">
              Player Error
            </div>
            <div style="font-size: 14px;">
              ${message}
            </div>
          </div>
        `;
      }

      (async () => {
        try {
          await initPlayer(renderCreative);
        } catch (err) {
          showError(err);
        }
      })();
    </script>

  </body>
</html>
